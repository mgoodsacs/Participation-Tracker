<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Participation Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .student-box {
      background: #333;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .student-box input {
      width: 90%;
      margin-bottom: 5px;
      text-align: center;
    }
    .controls {
      margin-bottom: 20px;
    }
    button {
      margin: 2px;
    }
  </style>
</head>
<body>
  <h1>Participation Tracker</h1>
  <div class="controls">
    <select id="classDropdown">
      <option value="Red2">Red2 - 6th Grade Choir</option>
      <option value="White2">White2 - 6th Grade Choir</option>
      <option value="White3">White3 - Musical Theatre</option>
      <option value="Red4">Red4 - 8th Grade Choir</option>
      <option value="White4">White4 - 7th Grade Choir</option>
      <option value="Class6">Generic Class 1</option>
      <option value="Class7">Generic Class 2</option>
      <option value="Class8">Generic Class 3</option>
    </select>
    <input type="date" id="datePicker" />
    <button id="toggleEditMode">Toggle Edit Mode</button>
  </div>

  <div id="gridContainer" class="grid-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

   const firebaseConfig = {
  apiKey: "AIzaSyCybxkV-rl6f9EvzSasLV09uFA3XzY6gqg",
  authDomain: "participation-tracker-a1f77.firebaseapp.com",
  projectId: "participation-tracker-a1f77",
  storageBucket: "participation-tracker-a1f77.appspot.com",
  messagingSenderId: "992471258983",
  appId: "1:992471258983:web:a19d47a70a5cc91a1d2971"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const classDropdown = document.getElementById("classDropdown");
    const datePicker = document.getElementById("datePicker");
    const toggleEditBtn = document.getElementById("toggleEditMode");
    const gridContainer = document.getElementById("gridContainer");

    const today = new Date().toISOString().split("T")[0];
    datePicker.value = today;

    let currentClass = classDropdown.value;
    let currentDate = datePicker.value;
    let isEditMode = false;

    const ROWS = 5;
    const COLS = 10;
    const DEFAULT_SCORE = 5;

    classDropdown.addEventListener("change", () => {
      currentClass = classDropdown.value;
      loadClassData();
    });

    datePicker.addEventListener("change", () => {
      currentDate = datePicker.value;
      loadClassData();
    });

    toggleEditBtn.addEventListener("click", () => {
      isEditMode = !isEditMode;
      loadClassData();
    });

    async function loadClassData() {
      const docRef = doc(db, "participation", `${currentClass}_${currentDate}`);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        renderGrid(data.seats);
      } else {
        renderGrid();
      }
    }

    async function saveClassData(seats) {
      await setDoc(doc(db, "participation", `${currentClass}_${currentDate}`), {
        class: currentClass,
        date: currentDate,
        seats: seats
      });
    }

    function renderGrid(savedSeats = []) {
      gridContainer.innerHTML = "";
      const seats = [];

      for (let row = 0; row < ROWS; row++) {
        for (let col = 0; col < COLS; col++) {
          const seatIndex = (ROWS - row - 1) * COLS + col; // bottom-left to top-right
          const savedSeat = savedSeats[seatIndex] || {};
          const seat = {
            name: savedSeat.name || "",
            score: savedSeat.score ?? DEFAULT_SCORE
          };
          seats[seatIndex] = seat;

          const box = document.createElement("div");
          box.className = "student-box";
          box.draggable = isEditMode;

          box.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", seatIndex);
          });

          box.addEventListener("dragover", e => {
            if (isEditMode) e.preventDefault();
          });

          box.addEventListener("drop", e => {
            if (!isEditMode) return;
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
            const toIndex = seatIndex;
            const temp = seats[fromIndex];
            seats[fromIndex] = seats[toIndex];
            seats[toIndex] = temp;
            saveClassData(seats);
            renderGrid(seats);
          });

          const nameDiv = document.createElement(isEditMode ? "input" : "div");
          if (isEditMode) {
            nameDiv.type = "text";
            nameDiv.value = seat.name;
            nameDiv.addEventListener("input", () => {
              seats[seatIndex].name = nameDiv.value;
              saveClassData(seats);
            });
          } else {
            nameDiv.textContent = seat.name;
          }

          const scoreSpan = document.createElement("span");
          scoreSpan.textContent = `(${seat.score})`;

          const plusBtn = document.createElement("button");
          plusBtn.textContent = "+1";
          plusBtn.addEventListener("click", () => {
            seats[seatIndex].score++;
            scoreSpan.textContent = `(${seats[seatIndex].score})`;
            saveClassData(seats);
          });

          const minusBtn = document.createElement("button");
          minusBtn.textContent = "-1";
          minusBtn.addEventListener("click", () => {
            seats[seatIndex].score--;
            scoreSpan.textContent = `(${seats[seatIndex].score})`;
            saveClassData(seats);
          });

          box.appendChild(nameDiv);
          box.appendChild(scoreSpan);
          box.appendChild(plusBtn);
          box.appendChild(minusBtn);

          gridContainer.appendChild(box);
        }
      }
    }

    loadClassData();
  </script>
</body>
</html>
