<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choir Participation Tracker</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #controls { margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 10px; }
    .student-box {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      border-radius: 6px;
      cursor: move;
      background-color: #f0f0f0;
    }
    .green { background-color: #a8e6a1; }
    .yellow { background-color: #fff59d; }
    .orange { background-color: #ffcc80; }
    .red { background-color: #ef9a9a; }
    .edit-mode input { width: 100%; }
  </style>
</head>
<body>
  <div id="controls">
    <select id="classSelector"></select>
    <button onclick="toggleEditMode()">Toggle Edit Mode</button>
    <textarea id="nameInput" rows="4" cols="50" placeholder="Enter student names..."></textarea>
    <button onclick="populateNames()">Populate Names</button>
  </div>

  <div class="grid" id="seatingGrid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCybxkV-rl6f9EvzSasLV09uFA3XzY6gqg",
      authDomain: "participation-tracker-a1f77.firebaseapp.com",
      projectId: "participation-tracker-a1f77",
      storageBucket: "participation-tracker-a1f77.appspot.com",
      messagingSenderId: "992471258983",
      appId: "1:992471258983:web:a19d47a70a5cc91a1d2971"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const classList = [
      "Red2-6th",
      "White2-6th",
      "White3-Musical Theatre",
      "Red4-8th",
      "White4-7th",
      "Class A",
      "Class B",
      "Class C"
    ];

    const grid = document.getElementById("seatingGrid");
    const selector = document.getElementById("classSelector");
    const nameInput = document.getElementById("nameInput");
    let currentClass = classList[0];
    let students = [];
    let editMode = false;

    classList.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      selector.appendChild(opt);
    });

    selector.addEventListener("change", async () => {
      currentClass = selector.value;
      await loadSeating();
      await dailyResetCheck();
      renderGrid();
    });

    function toggleEditMode() {
      editMode = !editMode;
      renderGrid();
    }

    async function populateNames() {
      const names = nameInput.value.trim().split("\n").filter(n => n);
      students = names.map(name => ({ name, points: 5 }));
      await saveSeating();
      await saveTodayScores();
      renderGrid();
    }

    function getColor(points) {
      if (points >= 5) return "green";
      if (points >= 3) return "yellow";
      if (points >= 1) return "orange";
      return "red";
    }

    function renderGrid() {
      grid.innerHTML = "";
      students.forEach((student, i) => {
        const div = document.createElement("div");
        div.className = `student-box ${getColor(student.points)}`;

        if (editMode) {
          const input = document.createElement("input");
          input.value = student.name;
          input.onchange = async () => {
            student.name = input.value;
            await saveSeating();
          };
          div.appendChild(input);
        } else {
          div.innerHTML = `
            <div>${student.name}</div>
            <div>
              <button onclick="adjustPoints(${i}, -1)">-1</button>
              <span>${student.points}</span>
              <button onclick="adjustPoints(${i}, 1)">+1</button>
            </div>
          `;
        }
        grid.appendChild(div);
      });
    }

    window.adjustPoints = async (index, delta) => {
      let s = students[index];
      s.points = Math.min(10, Math.max(-5, s.points + delta));
      await saveTodayScores();
      renderGrid();
    };

    async function saveSeating() {
      await setDoc(doc(db, "seating", currentClass), { students });
    }

    async function loadSeating() {
      const docSnap = await getDoc(doc(db, "seating", currentClass));
      students = docSnap.exists() ? docSnap.data().students : [];
    }

    async function saveTodayScores() {
      const today = new Date().toISOString().split("T")[0];
      await setDoc(doc(db, `scores/${today}/${currentClass}`), { students });
    }

    async function loadTodayScores() {
      const today = new Date().toISOString().split("T")[0];
      const docSnap = await getDoc(doc(db, `scores/${today}/${currentClass}`));
      if (docSnap.exists()) {
        students = docSnap.data().students;
      }
    }

    async function dailyResetCheck() {
      const today = new Date().toISOString().split("T")[0];
      const lastDate = localStorage.getItem("lastResetDate");
      if (lastDate !== today) {
        await loadSeating();
        students = students.map(s => ({ ...s, points: 5 }));
        await saveTodayScores();
        localStorage.setItem("lastResetDate", today);
      } else {
        await loadTodayScores();
      }
    }

    await loadSeating();
    await dailyResetCheck();
    renderGrid();
  </script>
</body>
</html>
