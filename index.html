<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Participation Tracker</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: sans-serif;
      padding: 1rem;
    }
    select, button, input {
      background-color: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
      padding: 5px;
      margin: 5px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .student {
      background-color: #333;
      padding: 10px;
      border: 1px solid #555;
      cursor: move;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Participation Tracker</h1>
  <select id="classSelector"></select>
  <button onclick="toggleEdit()">Toggle Edit Mode</button>
  <button onclick="loadScoresForDate()">Load Past Scores</button>
  <input type="date" id="datePicker" />

  <div id="grid" class="grid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZrtFqgzS4ZFANgQZLT13HQs8lAecuJyM",
      authDomain: "class-tracker-3b9ff.firebaseapp.com",
      projectId: "class-tracker-3b9ff",
      storageBucket: "class-tracker-3b9ff.appspot.com",
      messagingSenderId: "761182403925",
      appId: "1:761182403925:web:86129fe303884abfe0c3dc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const classSelector = document.getElementById("classSelector");
    const grid = document.getElementById("grid");
    const datePicker = document.getElementById("datePicker");

    const defaultClasses = [
      "Red2-6th grade choir",
      "White2-6th grade choir",
      "White3-Musical Theatre",
      "Red4-8th grade choir",
      "White4-7th grade choir",
      "Class A",
      "Class B",
      "Class C"
    ];

    let currentClass = defaultClasses[0];
    let students = {};
    let editMode = false;

    defaultClasses.forEach(cls => {
      const option = document.createElement("option");
      option.textContent = cls;
      classSelector.appendChild(option);
    });

    classSelector.addEventListener("change", () => {
      currentClass = classSelector.value;
      loadStudents(currentClass);
    });

    function createStudentElement(name, score) {
      const studentEl = document.createElement("div");
      studentEl.className = "student";
      studentEl.draggable = editMode;
      studentEl.dataset.name = name;
      studentEl.dataset.score = score;

      studentEl.innerHTML = `
        <div>${name}</div>
        <div>Score: <span class="score">${score}</span></div>
        <div class="buttons">
          <button onclick="changeScore('${name}', 1)">+1</button>
          <button onclick="changeScore('${name}', -1)">-1</button>
        </div>
      `;

      studentEl.addEventListener("dragstart", dragStart);
      studentEl.addEventListener("drop", drop);
      studentEl.addEventListener("dragover", allowDrop);

      return studentEl;
    }

    function loadStudents(cls) {
      grid.innerHTML = "";
      if (!students[cls]) {
        students[cls] = [];
        for (let i = 0; i < 50; i++) {
          students[cls].push({ name: `Student ${i + 1}`, score: 5 });
        }
      }

      students[cls].forEach((s) => {
        const el = createStudentElement(s.name, s.score);
        grid.appendChild(el);
      });
    }

    window.changeScore = function(name, delta) {
      const list = students[currentClass];
      const student = list.find(s => s.name === name);
      if (!student) return;
      student.score = Math.max(-5, Math.min(10, student.score + delta));
      loadStudents(currentClass);
    };

    function toggleEdit() {
      editMode = !editMode;
      loadStudents(currentClass);
    }

    function dragStart(e) {
      e.dataTransfer.setData("text", e.target.dataset.name);
    }

    function allowDrop(e) {
      e.preventDefault();
    }

    function drop(e) {
      e.preventDefault();
      const draggedName = e.dataTransfer.getData("text");
      const targetName = e.target.closest(".student").dataset.name;

      const list = students[currentClass];
      const draggedIndex = list.findIndex(s => s.name === draggedName);
      const targetIndex = list.findIndex(s => s.name === targetName);

      if (draggedIndex !== -1 && targetIndex !== -1) {
        const temp = list[draggedIndex];
        list[draggedIndex] = list[targetIndex];
        list[targetIndex] = temp;
        loadStudents(currentClass);
      }
    }

    async function saveToFirestore() {
      const today = new Date().toISOString().split("T")[0];
      const scores = {};
      students[currentClass].forEach(s => {
        scores[s.name] = s.score;
      });

      const ref = doc(db, "scores", `${currentClass}__${today}`);
      await setDoc(ref, scores);
      console.log(`Saved scores for ${currentClass} on ${today}`);
    }

    async function loadScoresForDate() {
      const date = datePicker.value;
      if (!date) return alert("Pick a date first!");

      const ref = doc(db, "scores", `${currentClass}__${date}`);
      const snapshot = await getDoc(ref);
      if (!snapshot.exists()) {
        alert("No data found for this date.");
        return;
      }

      const data = snapshot.data();
      students[currentClass] = Object.entries(data).map(([name, score]) => ({ name, score }));
      loadStudents(currentClass);
    }

    function checkTimeForAutoSave() {
      const now = new Date();
      if (now.getHours() === 14 && now.getMinutes() === 30) {
        saveToFirestore();
      }
    }

    function checkMidnightReset() {
      const lastDate = localStorage.getItem("lastDate") || "";
      const today = new Date().toISOString().split("T")[0];
      if (lastDate !== today) {
        // New day: reset scores
        defaultClasses.forEach(cls => {
          if (students[cls]) {
            students[cls].forEach(s => s.score = 5);
          }
        });
        localStorage.setItem("lastDate", today);
        loadStudents(currentClass);
      }
    }

    setInterval(checkTimeForAutoSave, 60000); // every minute
    checkMidnightReset();
    loadStudents(currentClass);
  </script>
</body>
</html>
